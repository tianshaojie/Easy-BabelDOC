name: Build PyInstaller Bundles

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (for example v1.0.0)"
        required: true
      name:
        description: "Release title (defaults to tag when omitted)"
        required: false
      notes:
        description: "Release notes (supports Markdown)"
        required: false

jobs:
  package:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Prepare backend static assets
        shell: bash
        run: |
          rm -rf backend/static/dist
          mkdir -p backend/static
          cp -R dist backend/static/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r backend/requirements.txt
          python -m pip install pyinstaller

      - name: Build executable with PyInstaller
        working-directory: backend
        run: pyinstaller main.spec --clean

      - name: Package bundle
        run: |
          python - <<'PY'
import pathlib
import shutil

archive = pathlib.Path(f"Easy-BabelDOC-${{ matrix.os }}")
shutil.make_archive(str(archive), "zip", "backend/dist")
PY

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: Easy-BabelDOC-${{ matrix.os }}
          path: Easy-BabelDOC-${{ matrix.os }}.zip

  release:
    name: Publish Release
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded files
        run: ls -R artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.name || github.event.inputs.tag }}
          body: ${{ github.event.inputs.notes }}
          files: artifacts/**/*
